---
title: "ssl证书理解"
subtitle: " "
layout: post
author: "Tidcl"
header-style: text
hidden: false
plchart: true
tags:
  - ssl
  - nginx
  - docker
  - https
---





## 工具：openssl、nginx、docker

## 操作过程：

1. 创建根CA证书 目的：用来给服务器证书签名，安装到设备上用来进行安全验证
2.  创建服务器证书，并经过CA私钥签名
3. 配置nginx的服务器：
       ssl_certificate {替换成证书路径}/server.crt.pem;
       ssl_certificate_key {替换成证书路径}/server.key.pem;
4. 在设备中安装CA证书
   windows双击ca.crt文件便可以安装证书，需要安装到“受信任的根证书颁发机构”分组里面。通过证书管理器管理证书 按win+R 输入 certmgr.msc。

## 对证书工作的理解：
首先openssl生成了两份公钥和密钥，一份是CA机构的，一份服务器的，将服务器的信息通过CA密钥进行签名生成数字签名字符串，服务器证书+CA数字签名字符串组成完整的电子证书。此时便可以将电子证书和服务器密钥配置到nginx服务器中。
当客户端对服务器进行请求，服务器返回电子证书，客户端对电子证书中的服务器信息进行hash并解密数字签名字符串，此时解密所需的CA公钥就在我们**安装在系统中的CA证书**里面，如果没有安装证书，浏览器会提示网站不可信（当然可以强制访问并不影响服务器跟你验证，服务器公钥已经通过电子证书给你了，可以使用该公钥加密），安装了CA证书会通过电子证书中信息找到系统环境中CA公钥，将证书中服务器信息hash得到的哈希字符串和解码电子签名字符串得到的哈希字符串进行对比，如果一致验证通过通信开始。

## 使用https为什么攻击者没那么容易攻击你了？

首先非对称加密，**公钥加密私钥解密，私钥加密公钥解密**。
在没有CA机构对服务器信息进行保证时，攻击者只需要创建一对公钥和密钥，客户端与服务器建立连接，攻击者截取到客户端与服务器的通信意图，攻击者向服务器建立连接得到服务器的公钥，并将伪造的公钥发送给客户端，客户端使用攻击者的公钥进行数据加密并将加密的数据发送到攻击者的地址。攻击者获取到客户端的加密数据使用自己的密钥进行解密就能得到明文数据了，再将明文数据使用服务器公钥进行加密发送给服务器即可，就这样神不知鬼不觉在中间完成**代理**和密文解密。
在上面的场景中，攻击者对于客户端的攻击只是伪造了公钥，简单来想也就只是这样，因为公钥没被保护。引入CA机构后，服务器的公钥可信度得到了大大加强，每个服务器想使用https进行通信就需要将服务器信息和公钥交给CA机构，CA机构对这些信息进行签名，生成数字签名返回给客户端。服务器拿到CA返回的数字签名后，就可以加上服务器信息和公钥组成通信用的电子证书。
回到上面的场景，攻击者同样升级了，伪造证书中的公钥返回给客户端。当客户端拿到伪造证书进行验证时，使用CA公钥对证书中的数字签名进行解密得到哈希字符串，再对证书中的服务器信息和公钥进行hash得到哈希字符串。因为服务器公钥被攻击者伪造，两个哈希字符串不相等，验证失败拒绝建立通信。
上面因为攻击者只是伪造了证书中的公钥导致连接建立失败，此时攻击者再次升级，除了伪造公钥也伪造了数字签名（攻击者使用自己的密钥，对服务器信息和公钥进行加密得到伪造的电子签名），攻击者将伪造的电子证书发给客户端。客户端使用CA公钥对电子证书中的数字签名进行解密得到哈希字符串，客户端再将证书中的服务器信息和公钥进行hash得到哈希字符串，对比不一致，这是因为攻击者伪造了公钥和数字签名，但是攻击者使用的是非CA密钥伪造的数字签名，客户端使用CA公钥进行解密就会得到八竿子打不着的哈希字符串。在上面的场景中，攻击者因为对称加密的特性导致攻击失败。
根据上面的情况可以知道，客户端中的CA的公钥一旦被攻破，也会导致攻击成功。保护CA密钥是非常重要的，CA密钥更新也会导致牵一发而动全身的效果。

## 参考文章：
【使用openssl创建自签名证书】https://zhuanlan.zhihu.com/p/624493014
【nginx开启ssl并把http重定向到https的两种方式】https://www.cnblogs.com/larrydpk/p/12819231.html